
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Secure Messaging</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; }
    #message { width: 80%; padding: 5px; }
    #send { padding: 5px; }
    .my-message { color: blue; text-align: right; }
    .peer-message { color: green; text-align: left; }
    .user-badge { position: fixed; top: 10px; right: 12px; font-family: Arial, sans-serif;
                background: rgba(0,0,0,0.6); color:#fff; padding: 6px 10px; border-radius: 12px;
                font-size: 12px; z-index: 9999; }
    .user-badge a { color:#ffd1d1; text-decoration:none; margin-left:8px; }
  </style>
</head>
<body

  data-current-user-id="{{ current_user_id }}"
  data-chat-id="{{ chat_id }}"
  data-peer-id="{{ peer_id }}"
  data-peer-name="{{ peer_name }}"
  data-current-username="{{ current_username }}"
  data-chat-token="{{ chat_token }}"
>
  {% if current_username %}
  <div class="user-badge">
    Logged as {{ current_username }} <a href="/logout" title="Log out">Logout</a>
  </div>
  {% endif %}

  <h2>Secure Messaging</h2>

  <div id="chat"></div>

  <form id="chatForm">
    <input type="text" name="message" id="message" placeholder="Your message">
    <input type="submit" value="Send" id="send">
  </form>

  <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
  <script>
    const socket = io();

    const currentUserId   = Number(document.body.dataset.currentUserId);
    const chatId          = document.body.dataset.chatId;
    const peerName        = document.body.dataset.peerName;
    const currentUsername = document.body.dataset.currentUsername;
    const chatToken       = document.body.dataset.chatToken;

    const chatDiv = document.getElementById("chat");
    const form    = document.getElementById("chatForm");
    const input   = document.getElementById("message");

    socket.on("connect", () => {
      socket.emit("join_chat", {chat_id: chatId});
    })

    socket.on("chat_history", messages => {
    renderMessages(messages);
  });

  socket.on("new_message", data => {
    renderMessages([data]); // append single new message
  });

  form.addEventListener("submit", e => {
    e.preventDefault();
    const messageText = input.value.trim();
    if (!messageText) return;
    socket.emit("send_message", {chat_id: chatId, message: messageText});
    input.value = "";
  });

  function renderMessages(messages) {
    messages.forEach(msg => {
      const p = document.createElement("p");
      const fromId = parseInt(msg.from, 10);
      p.textContent = (fromId === currentUserId ? "Me: " : peerName + ": ") + msg.msg;
      p.className = (fromId === currentUserId ? "my-message" : "peer-message");
      chatDiv.appendChild(p);
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

    // function renderMessages(messages) {
    //   chatDiv.innerHTML = "";
    //   messages.forEach(msg => {
    //     const p = document.createElement("p");
    //     const fromId = parseInt(msg.from, 10);
    //     if (fromId === currentUserId) {
    //         p.textContent = "Me: " + msg.msg;
    //         p.className = "my-message";
    //     } else {
    //         p.textContent = peerName + ": " + msg.msg;
    //         p.className = "peer-message";
    //     }
    //     chatDiv.appendChild(p);
    //   });
    //   chatDiv.scrollTop = chatDiv.scrollHeight;
    // }

    // function fetchMessages() {
    //   fetch(`/get_messages/${chatId}`, {
    //     headers: {'X-Chat-Token': chatToken}
    //   })
    //     .then(resp => resp.json())
    //     .then(messages => {
    //       console.log("currentUserId:", currentUserId, "chatId:", chatId, "messages:", messages);
    //       renderMessages(messages);
    //     })
    //     .catch(err => console.error("fetchMessages error:", err));
    // }

    // setInterval(fetchMessages, 2000);
    // fetchMessages();

    // form.addEventListener("submit", e => {
    //   e.preventDefault();
    //   const messageText = input.value.trim();
    //   if (!messageText) return;
    //   fetch(`/send_message/${chatId}`, {
    //     method: "POST",
    //     headers: {
    //       'Content-Type': 'application/x-www-form-urlencoded',
    //       'X-Chat-Token': chatToken
    //     },
    //     body: `message=${encodeURIComponent(messageText)}`
    //   })
    //   .then(() => { input.value = ""; fetchMessages(); })
    //   .catch(err => console.error("send error:", err));
    // });
  </script>
</body>
</html>
